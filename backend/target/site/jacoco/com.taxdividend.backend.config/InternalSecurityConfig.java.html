<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InternalSecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.taxdividend.backend.config</a> &gt; <span class="el_source">InternalSecurityConfig.java</span></div><h1>InternalSecurityConfig.java</h1><pre class="source lang-java linenums">package com.taxdividend.backend.config;

import java.io.IOException;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;

/**
 * Security configuration for internal backend services.
 *
 * This backend is designed to be called ONLY by the BFF Gateway, not directly
 * by clients.
 * Authentication is handled via the X-User-Id header passed from the BFF.
 *
 * Public endpoints:
 * - /actuator/health/** - Health checks for monitoring (Kubernetes, Docker,
 * etc.)
 * - /actuator/prometheus - Prometheus metrics scraping
 * - /swagger-ui/** - API documentation (consider restricting in production)
 * - /v3/api-docs/** - OpenAPI schema
 *
 * All other endpoints require X-User-Id header.
 */
<span class="nc" id="L40">@Slf4j</span>
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
<span class="nc" id="L44">public class InternalSecurityConfig {</span>

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
<span class="nc" id="L48">        return http</span>
                // Disable CSRF (stateless API with header-based auth)
<span class="nc" id="L50">                .csrf(AbstractHttpConfigurer::disable)</span>

                // Stateless session (no cookies)
<span class="nc" id="L53">                .sessionManagement(session -&gt; session</span>
<span class="nc" id="L54">                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS))</span>

                // Authorization rules
<span class="nc" id="L57">                .authorizeHttpRequests(auth -&gt; auth</span>
                        // Public health checks - NO authentication required
<span class="nc" id="L59">                        .requestMatchers(&quot;/actuator/health&quot;, &quot;/actuator/health/**&quot;).permitAll()</span>

                        // Public Prometheus metrics - NO authentication required (secured by network)
<span class="nc" id="L62">                        .requestMatchers(&quot;/actuator/prometheus&quot;).permitAll()</span>

                        // All other actuator endpoints require authentication
<span class="nc" id="L65">                        .requestMatchers(&quot;/actuator/**&quot;).authenticated()</span>

                        // API Documentation - Public (consider restricting in production)
<span class="nc" id="L68">                        .requestMatchers(&quot;/swagger-ui/**&quot;, &quot;/v3/api-docs/**&quot;).permitAll()</span>

                        // Error handling
<span class="nc" id="L71">                        .requestMatchers(&quot;/error&quot;).permitAll()</span>

                        // All other requests require authentication (X-User-Id header)
<span class="nc" id="L74">                        .anyRequest().authenticated())</span>

                // Add custom filter to validate X-User-Id header
<span class="nc" id="L77">                .addFilterBefore(new InternalSecurityFilter(), UsernamePasswordAuthenticationFilter.class)</span>

<span class="nc" id="L79">                .build();</span>
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
<span class="nc" id="L84">        return new BCryptPasswordEncoder(12);</span>
    }

    /**
     * Custom filter to validate X-User-Id header from BFF Gateway.
     *
     * This filter runs for all requests EXCEPT public endpoints (actuator health,
     * prometheus, swagger).
     * It extracts the X-User-Id header and creates a Spring Security authentication
     * token.
     */
<span class="nc" id="L95">    @Slf4j</span>
<span class="nc" id="L96">    public static class InternalSecurityFilter extends OncePerRequestFilter {</span>

<span class="nc" id="L98">        private final com.fasterxml.jackson.databind.ObjectMapper objectMapper = new com.fasterxml.jackson.databind.ObjectMapper();</span>

        @Override
        protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                FilterChain filterChain) throws ServletException, IOException {

<span class="nc" id="L104">            String requestUri = request.getRequestURI();</span>

            // Skip authentication for public endpoints
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (isPublicEndpoint(requestUri)) {</span>
<span class="nc" id="L108">                log.debug(&quot;Public endpoint accessed: {}&quot;, requestUri);</span>
<span class="nc" id="L109">                filterChain.doFilter(request, response);</span>
<span class="nc" id="L110">                return;</span>
            }

            // Extract X-User-Context header (set by BFF Gateway)
<span class="nc" id="L114">            String contextHeader = request.getHeader(&quot;X-User-Context&quot;);</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">            if (contextHeader == null || contextHeader.isEmpty()) {</span>
<span class="nc" id="L116">                log.warn(&quot;Missing X-User-Context header for protected endpoint: {}&quot;, requestUri);</span>
<span class="nc" id="L117">                response.sendError(HttpServletResponse.SC_UNAUTHORIZED,</span>
                        &quot;Missing X-User-Context header. This service must be called through the BFF Gateway.&quot;);
<span class="nc" id="L119">                return;</span>
            }

            try {
                // Decode Base64 and parse JSON
<span class="nc" id="L124">                byte[] decodedBytes = java.util.Base64.getDecoder().decode(contextHeader);</span>
<span class="nc" id="L125">                com.taxdividend.backend.security.UserContext userContext = objectMapper.readValue(decodedBytes,</span>
                        com.taxdividend.backend.security.UserContext.class);

<span class="nc" id="L128">                log.debug(&quot;Authenticated request for user: {} ({}) on endpoint: {}&quot;, userContext.userId(),</span>
<span class="nc" id="L129">                        userContext.email(), requestUri);</span>

                // Map roles to authorities
                java.util.List&lt;org.springframework.security.core.authority.SimpleGrantedAuthority&gt; authorities = java.util.Collections
<span class="nc" id="L133">                        .emptyList();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">                if (userContext.roles() != null) {</span>
<span class="nc" id="L135">                    authorities = userContext.roles().stream()</span>
<span class="nc" id="L136">                            .map(org.springframework.security.core.authority.SimpleGrantedAuthority::new)</span>
<span class="nc" id="L137">                            .collect(java.util.stream.Collectors.toList());</span>
                }

                // Create authentication token
<span class="nc" id="L141">                org.springframework.security.authentication.UsernamePasswordAuthenticationToken auth = new org.springframework.security.authentication.UsernamePasswordAuthenticationToken(</span>
<span class="nc" id="L142">                        userContext.userId(), userContext, authorities);</span>

<span class="nc" id="L144">                org.springframework.security.core.context.SecurityContextHolder.getContext().setAuthentication(auth);</span>
<span class="nc" id="L145">                filterChain.doFilter(request, response);</span>

<span class="nc" id="L147">            } catch (Exception e) {</span>
<span class="nc" id="L148">                log.error(&quot;Failed to parse UserContext&quot;, e);</span>
<span class="nc" id="L149">                response.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;Invalid UserContext&quot;);</span>
<span class="nc" id="L150">            }</span>
<span class="nc" id="L151">        }</span>

        /**
         * Check if the request URI is a public endpoint that doesn't require
         * authentication.
         */
        private boolean isPublicEndpoint(String uri) {
<span class="nc bnc" id="L158" title="All 2 branches missed.">            return uri.startsWith(&quot;/actuator/health&quot;) ||</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                    uri.equals(&quot;/actuator/prometheus&quot;) ||</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                    uri.startsWith(&quot;/swagger-ui&quot;) ||</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                    uri.startsWith(&quot;/v3/api-docs&quot;) ||</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">                    uri.equals(&quot;/error&quot;);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>