<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PdfGenerationServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.taxdividend.backend.service.impl</a> &gt; <span class="el_source">PdfGenerationServiceImpl.java</span></div><h1>PdfGenerationServiceImpl.java</h1><pre class="source lang-java linenums">package com.taxdividend.backend.service.impl;

import com.taxdividend.backend.dto.FileUploadResultDTO;
import com.taxdividend.backend.api.dto.FormGenerationRequest;
import com.taxdividend.backend.dto.GenerateFormResultDTO;
import com.taxdividend.backend.exception.PdfGenerationException;
import com.taxdividend.backend.model.Dividend;
import com.taxdividend.backend.model.GeneratedForm;
import com.taxdividend.backend.model.User;
import com.taxdividend.backend.repository.DividendRepository;
import com.taxdividend.backend.repository.GeneratedFormRepository;
import com.taxdividend.backend.repository.UserRepository;
import com.taxdividend.backend.service.PdfGenerationService;
import com.taxdividend.backend.service.StorageService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.PDPageContentStream;
import org.apache.pdfbox.pdmodel.common.PDRectangle;
import org.apache.pdfbox.pdmodel.font.PDType1Font;
import org.apache.pdfbox.pdmodel.font.Standard14Fonts;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.math.BigDecimal;
import java.time.Duration;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.UUID;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

/**
 * Implementation of PDF generation service using Apache PDFBox.
 *
 * NOTE: This is a simplified implementation that generates basic PDFs.
 * In production, you would use official PDF templates for Forms 5000/5001.
 */
<span class="fc" id="L45">@Slf4j</span>
@Service
@RequiredArgsConstructor
public class PdfGenerationServiceImpl implements PdfGenerationService {

    private final UserRepository userRepository;
    private final DividendRepository dividendRepository;
    private final GeneratedFormRepository generatedFormRepository;
    private final StorageService storageService;

    @Value(&quot;${app.forms.expiry-days:30}&quot;)
    private int formExpiryDays;

<span class="fc" id="L58">    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy&quot;);</span>

    @Override
    @Transactional
    public GenerateFormResultDTO generateForms(FormGenerationRequest request) {
<span class="fc" id="L63">        long startTime = System.currentTimeMillis();</span>

<span class="fc" id="L65">        log.info(&quot;Generating forms for user {} - type: {}, year: {}&quot;,</span>
<span class="fc" id="L66">                 request.getUserId(), request.getFormType(), request.getTaxYear());</span>

        try {
<span class="fc" id="L69">            User user = userRepository.findById(request.getUserId())</span>
<span class="fc" id="L70">                    .orElseThrow(() -&gt; new PdfGenerationException(&quot;User not found: &quot; + request.getUserId()));</span>

            GenerateFormResultDTO result;

<span class="pc bpc" id="L74" title="3 of 4 branches missed.">            switch (request.getFormType().getValue()) {</span>
                case &quot;5000&quot;:
<span class="nc" id="L76">                    result = generateForm5000(user, request.getTaxYear());</span>
<span class="nc" id="L77">                    break;</span>

                case &quot;5001&quot;:
<span class="pc bpc" id="L80" title="2 of 4 branches missed.">                    if (request.getDividendIds() == null || request.getDividendIds().isEmpty()) {</span>
<span class="nc" id="L81">                        throw new PdfGenerationException(&quot;Dividend IDs required for Form 5001&quot;);</span>
                    }
<span class="fc" id="L83">                    List&lt;Dividend&gt; dividends = dividendRepository.findAllById(request.getDividendIds());</span>
<span class="fc" id="L84">                    result = generateForm5001(user, dividends, request.getTaxYear());</span>
<span class="fc" id="L85">                    break;</span>

                case &quot;BUNDLE&quot;:
<span class="nc bnc" id="L88" title="All 4 branches missed.">                    if (request.getDividendIds() == null || request.getDividendIds().isEmpty()) {</span>
<span class="nc" id="L89">                        throw new PdfGenerationException(&quot;Dividend IDs required for BUNDLE&quot;);</span>
                    }
<span class="nc" id="L91">                    List&lt;Dividend&gt; bundleDividends = dividendRepository.findAllById(request.getDividendIds());</span>
<span class="nc" id="L92">                    result = generateBundle(user, bundleDividends, request.getTaxYear());</span>
<span class="nc" id="L93">                    break;</span>

                default:
<span class="nc" id="L96">                    throw new PdfGenerationException(&quot;Invalid form type: &quot; + request.getFormType());</span>
            }

<span class="fc" id="L99">            result.setProcessingTimeMs(System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L100">            log.info(&quot;Form generation completed in {}ms&quot;, result.getProcessingTimeMs());</span>

<span class="fc" id="L102">            return result;</span>

<span class="fc" id="L104">        } catch (Exception e) {</span>
<span class="fc" id="L105">            log.error(&quot;Failed to generate forms&quot;, e);</span>
<span class="fc" id="L106">            return GenerateFormResultDTO.builder()</span>
<span class="fc" id="L107">                    .success(false)</span>
<span class="fc" id="L108">                    .errors(List.of(&quot;Generation failed: &quot; + e.getMessage()))</span>
<span class="fc" id="L109">                    .processingTimeMs(System.currentTimeMillis() - startTime)</span>
<span class="fc" id="L110">                    .build();</span>
        }
    }

    @Override
    @Transactional
    public GenerateFormResultDTO generateForm5000(User user, Integer taxYear) {
<span class="fc" id="L117">        log.info(&quot;Generating Form 5000 for user {}, year {}&quot;, user.getId(), taxYear);</span>

        try {
<span class="fc" id="L120">            byte[] pdfBytes = createForm5000Pdf(user, taxYear);</span>

<span class="fc" id="L122">            String fileName = String.format(&quot;Form_5000_%s_%d.pdf&quot;, user.getEmail(), taxYear);</span>
<span class="fc" id="L123">            FileUploadResultDTO uploadResult = uploadFormPdf(pdfBytes, fileName, &quot;forms&quot;);</span>

<span class="pc bpc" id="L125" title="1 of 2 branches missed.">            if (!uploadResult.getSuccess()) {</span>
<span class="nc" id="L126">                throw new PdfGenerationException(&quot;Failed to upload Form 5000: &quot; + uploadResult.getErrorMessage());</span>
            }

            // Save to database
<span class="fc" id="L130">            GeneratedForm form = saveGeneratedForm(user, uploadResult, &quot;5000&quot;, taxYear, 0);</span>

            // Generate download URL
<span class="fc" id="L133">            String downloadUrl = storageService.generatePresignedUrl(form.getS3Key(), Duration.ofDays(7));</span>

<span class="fc" id="L135">            return GenerateFormResultDTO.builder()</span>
<span class="fc" id="L136">                    .formId(form.getId())</span>
<span class="fc" id="L137">                    .s3Key(form.getS3Key())</span>
<span class="fc" id="L138">                    .fileName(form.getFileName())</span>
<span class="fc" id="L139">                    .formType(&quot;5000&quot;)</span>
<span class="fc" id="L140">                    .taxYear(taxYear)</span>
<span class="fc" id="L141">                    .fileSize(uploadResult.getFileSize())</span>
<span class="fc" id="L142">                    .downloadUrl(downloadUrl)</span>
<span class="fc" id="L143">                    .downloadUrlExpiresAt(LocalDateTime.now().plusDays(7))</span>
<span class="fc" id="L144">                    .expiresAt(form.getExpiresAt())</span>
<span class="fc" id="L145">                    .generatedAt(LocalDateTime.now())</span>
<span class="fc" id="L146">                    .success(true)</span>
<span class="fc" id="L147">                    .dividendCount(0)</span>
<span class="fc" id="L148">                    .build();</span>

<span class="fc" id="L150">        } catch (Exception e) {</span>
<span class="fc" id="L151">            log.error(&quot;Failed to generate Form 5000&quot;, e);</span>
<span class="fc" id="L152">            throw new PdfGenerationException(&quot;Form 5000 generation failed&quot;, e);</span>
        }
    }

    @Override
    @Transactional
    public GenerateFormResultDTO generateForm5001(User user, List&lt;Dividend&gt; dividends, Integer taxYear) {
<span class="fc" id="L159">        log.info(&quot;Generating Form 5001 for user {}, year {}, {} dividends&quot;,</span>
<span class="fc" id="L160">                 user.getId(), taxYear, dividends.size());</span>

        try {
<span class="fc" id="L163">            byte[] pdfBytes = createForm5001Pdf(user, dividends, taxYear);</span>

<span class="fc" id="L165">            String fileName = String.format(&quot;Form_5001_%s_%d.pdf&quot;, user.getEmail(), taxYear);</span>
<span class="fc" id="L166">            FileUploadResultDTO uploadResult = uploadFormPdf(pdfBytes, fileName, &quot;forms&quot;);</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">            if (!uploadResult.getSuccess()) {</span>
<span class="nc" id="L169">                throw new PdfGenerationException(&quot;Failed to upload Form 5001: &quot; + uploadResult.getErrorMessage());</span>
            }

            // Save to database
<span class="fc" id="L173">            GeneratedForm form = saveGeneratedForm(user, uploadResult, &quot;5001&quot;, taxYear, dividends.size());</span>

            // Link dividends to this form
<span class="fc bfc" id="L176" title="All 2 branches covered.">            for (Dividend dividend : dividends) {</span>
<span class="fc" id="L177">                dividend.setForm(form);</span>
<span class="fc" id="L178">                dividendRepository.save(dividend);</span>
<span class="fc" id="L179">            }</span>

            // Generate download URL
<span class="fc" id="L182">            String downloadUrl = storageService.generatePresignedUrl(form.getS3Key(), Duration.ofDays(7));</span>

<span class="fc" id="L184">            return GenerateFormResultDTO.builder()</span>
<span class="fc" id="L185">                    .formId(form.getId())</span>
<span class="fc" id="L186">                    .s3Key(form.getS3Key())</span>
<span class="fc" id="L187">                    .fileName(form.getFileName())</span>
<span class="fc" id="L188">                    .formType(&quot;5001&quot;)</span>
<span class="fc" id="L189">                    .taxYear(taxYear)</span>
<span class="fc" id="L190">                    .fileSize(uploadResult.getFileSize())</span>
<span class="fc" id="L191">                    .downloadUrl(downloadUrl)</span>
<span class="fc" id="L192">                    .downloadUrlExpiresAt(LocalDateTime.now().plusDays(7))</span>
<span class="fc" id="L193">                    .expiresAt(form.getExpiresAt())</span>
<span class="fc" id="L194">                    .generatedAt(LocalDateTime.now())</span>
<span class="fc" id="L195">                    .success(true)</span>
<span class="fc" id="L196">                    .dividendCount(dividends.size())</span>
<span class="fc" id="L197">                    .build();</span>

<span class="fc" id="L199">        } catch (Exception e) {</span>
<span class="fc" id="L200">            log.error(&quot;Failed to generate Form 5001&quot;, e);</span>
<span class="fc" id="L201">            throw new PdfGenerationException(&quot;Form 5001 generation failed&quot;, e);</span>
        }
    }

    @Override
    @Transactional
    public GenerateFormResultDTO generateBundle(User user, List&lt;Dividend&gt; dividends, Integer taxYear) {
<span class="fc" id="L208">        log.info(&quot;Generating BUNDLE for user {}, year {}&quot;, user.getId(), taxYear);</span>

        try {
            // Generate both PDFs
<span class="fc" id="L212">            byte[] form5000Pdf = createForm5000Pdf(user, taxYear);</span>
<span class="fc" id="L213">            byte[] form5001Pdf = createForm5001Pdf(user, dividends, taxYear);</span>

            // Create ZIP bundle
<span class="fc" id="L216">            byte[] zipBytes = createZipBundle(form5000Pdf, form5001Pdf, user.getEmail(), taxYear);</span>

<span class="fc" id="L218">            String fileName = String.format(&quot;Bundle_%s_%d.zip&quot;, user.getEmail(), taxYear);</span>
<span class="fc" id="L219">            FileUploadResultDTO uploadResult = uploadFormPdf(zipBytes, fileName, &quot;bundles&quot;);</span>

<span class="pc bpc" id="L221" title="1 of 2 branches missed.">            if (!uploadResult.getSuccess()) {</span>
<span class="nc" id="L222">                throw new PdfGenerationException(&quot;Failed to upload BUNDLE: &quot; + uploadResult.getErrorMessage());</span>
            }

            // Save to database
<span class="fc" id="L226">            GeneratedForm form = saveGeneratedForm(user, uploadResult, &quot;BUNDLE&quot;, taxYear, dividends.size());</span>

            // Link dividends to this form
<span class="fc bfc" id="L229" title="All 2 branches covered.">            for (Dividend dividend : dividends) {</span>
<span class="fc" id="L230">                dividend.setForm(form);</span>
<span class="fc" id="L231">                dividendRepository.save(dividend);</span>
<span class="fc" id="L232">            }</span>

            // Generate download URL
<span class="fc" id="L235">            String downloadUrl = storageService.generatePresignedUrl(form.getS3Key(), Duration.ofDays(7));</span>

<span class="fc" id="L237">            return GenerateFormResultDTO.builder()</span>
<span class="fc" id="L238">                    .formId(form.getId())</span>
<span class="fc" id="L239">                    .s3Key(form.getS3Key())</span>
<span class="fc" id="L240">                    .fileName(form.getFileName())</span>
<span class="fc" id="L241">                    .formType(&quot;BUNDLE&quot;)</span>
<span class="fc" id="L242">                    .taxYear(taxYear)</span>
<span class="fc" id="L243">                    .fileSize(uploadResult.getFileSize())</span>
<span class="fc" id="L244">                    .downloadUrl(downloadUrl)</span>
<span class="fc" id="L245">                    .downloadUrlExpiresAt(LocalDateTime.now().plusDays(7))</span>
<span class="fc" id="L246">                    .expiresAt(form.getExpiresAt())</span>
<span class="fc" id="L247">                    .generatedAt(LocalDateTime.now())</span>
<span class="fc" id="L248">                    .success(true)</span>
<span class="fc" id="L249">                    .dividendCount(dividends.size())</span>
<span class="fc" id="L250">                    .build();</span>

<span class="nc" id="L252">        } catch (Exception e) {</span>
<span class="nc" id="L253">            log.error(&quot;Failed to generate BUNDLE&quot;, e);</span>
<span class="nc" id="L254">            throw new PdfGenerationException(&quot;BUNDLE generation failed&quot;, e);</span>
        }
    }

    @Override
    @Transactional
    public GenerateFormResultDTO regenerateForm(UUID formId) {
<span class="fc" id="L261">        GeneratedForm existingForm = generatedFormRepository.findById(formId)</span>
<span class="fc" id="L262">                .orElseThrow(() -&gt; new PdfGenerationException(&quot;Form not found: &quot; + formId));</span>

<span class="fc" id="L264">        User user = existingForm.getUser();</span>
<span class="fc" id="L265">        Integer taxYear = existingForm.getTaxYear();</span>
<span class="fc" id="L266">        String formType = existingForm.getFormType();</span>

<span class="fc" id="L268">        log.info(&quot;Regenerating form {} (type: {}) for user {}&quot;, formId, formType, user.getId());</span>

<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        if (&quot;5000&quot;.equals(formType)) {</span>
<span class="fc" id="L271">            return generateForm5000(user, taxYear);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        } else if (&quot;5001&quot;.equals(formType)) {</span>
<span class="nc" id="L273">            List&lt;Dividend&gt; dividends = dividendRepository.findByFormId(formId);</span>
<span class="nc" id="L274">            return generateForm5001(user, dividends, taxYear);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        } else if (&quot;BUNDLE&quot;.equals(formType)) {</span>
<span class="nc" id="L276">            List&lt;Dividend&gt; dividends = dividendRepository.findByFormId(formId);</span>
<span class="nc" id="L277">            return generateBundle(user, dividends, taxYear);</span>
        } else {
<span class="nc" id="L279">            throw new PdfGenerationException(&quot;Unknown form type: &quot; + formType);</span>
        }
    }

    @Override
    @Transactional
    public GenerateFormResultDTO generateForUserDividends(UUID userId, Integer taxYear, String bundleType) {
<span class="nc" id="L286">        User user = userRepository.findById(userId)</span>
<span class="nc" id="L287">                .orElseThrow(() -&gt; new PdfGenerationException(&quot;User not found: &quot; + userId));</span>

<span class="nc" id="L289">        List&lt;Dividend&gt; unsubmittedDividends = dividendRepository.findByUserIdAndFormIsNull(userId);</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (unsubmittedDividends.isEmpty()) {</span>
<span class="nc" id="L292">            throw new PdfGenerationException(&quot;No unsubmitted dividends found for user&quot;);</span>
        }

<span class="nc" id="L295">        log.info(&quot;Generating {} for user {} with {} unsubmitted dividends&quot;,</span>
<span class="nc" id="L296">                 bundleType, userId, unsubmittedDividends.size());</span>

<span class="nc bnc" id="L298" title="All 4 branches missed.">        switch (bundleType.toUpperCase()) {</span>
            case &quot;5000&quot;:
<span class="nc" id="L300">                return generateForm5000(user, taxYear);</span>
            case &quot;5001&quot;:
<span class="nc" id="L302">                return generateForm5001(user, unsubmittedDividends, taxYear);</span>
            case &quot;BUNDLE&quot;:
<span class="nc" id="L304">                return generateBundle(user, unsubmittedDividends, taxYear);</span>
            default:
<span class="nc" id="L306">                throw new PdfGenerationException(&quot;Invalid bundle type: &quot; + bundleType);</span>
        }
    }

    // ========================================
    // Private Helper Methods
    // ========================================

    /**
     * Create Form 5000 PDF (Attestation de résidence fiscale).
     */
    private byte[] createForm5000Pdf(User user, Integer taxYear) throws IOException {
<span class="fc" id="L318">        try (PDDocument document = new PDDocument();</span>
<span class="fc" id="L319">             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {</span>

<span class="fc" id="L321">            PDPage page = new PDPage(PDRectangle.A4);</span>
<span class="fc" id="L322">            document.addPage(page);</span>

<span class="fc" id="L324">            try (PDPageContentStream contentStream = new PDPageContentStream(document, page)) {</span>
<span class="fc" id="L325">                float margin = 50;</span>
<span class="fc" id="L326">                float yPosition = page.getMediaBox().getHeight() - margin;</span>
<span class="fc" id="L327">                float fontSize = 12;</span>

<span class="fc" id="L329">                PDType1Font fontBold = new PDType1Font(Standard14Fonts.FontName.HELVETICA_BOLD);</span>
<span class="fc" id="L330">                PDType1Font fontRegular = new PDType1Font(Standard14Fonts.FontName.HELVETICA);</span>

                // Title
<span class="fc" id="L333">                contentStream.setFont(fontBold, 16);</span>
<span class="fc" id="L334">                contentStream.beginText();</span>
<span class="fc" id="L335">                contentStream.newLineAtOffset(margin, yPosition);</span>
<span class="fc" id="L336">                contentStream.showText(&quot;FORMULAIRE 5000&quot;);</span>
<span class="fc" id="L337">                contentStream.endText();</span>
<span class="fc" id="L338">                yPosition -= 20;</span>

<span class="fc" id="L340">                contentStream.setFont(fontBold, 14);</span>
<span class="fc" id="L341">                contentStream.beginText();</span>
<span class="fc" id="L342">                contentStream.newLineAtOffset(margin, yPosition);</span>
<span class="fc" id="L343">                contentStream.showText(&quot;Attestation de résidence fiscale en Suisse&quot;);</span>
<span class="fc" id="L344">                contentStream.endText();</span>
<span class="fc" id="L345">                yPosition -= 40;</span>

                // User details
<span class="fc" id="L348">                contentStream.setFont(fontRegular, fontSize);</span>
<span class="fc" id="L349">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
                        &quot;Année fiscale : &quot; + taxYear);
<span class="fc" id="L351">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">                        &quot;Nom complet : &quot; + (user.getFullName() != null ? user.getFullName() : &quot;N/A&quot;));</span>
<span class="fc" id="L353">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc" id="L354">                        &quot;Email : &quot; + user.getEmail());</span>
<span class="fc" id="L355">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">                        &quot;Adresse : &quot; + (user.getAddress() != null ? user.getAddress() : &quot;N/A&quot;));</span>
<span class="fc" id="L357">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">                        &quot;Canton : &quot; + (user.getCanton() != null ? user.getCanton() : &quot;N/A&quot;));</span>
<span class="fc" id="L359">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">                        &quot;NIF : &quot; + (user.getTaxId() != null ? user.getTaxId() : &quot;N/A&quot;));</span>
<span class="fc" id="L361">                yPosition -= 20;</span>

                // Attestation text
<span class="fc" id="L364">                contentStream.setFont(fontRegular, fontSize);</span>
<span class="fc" id="L365">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
                        &quot;Je soussigné(e), certifie que je suis résident(e) fiscal(e) en Suisse&quot;);
<span class="fc" id="L367">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
                        &quot;pour l'année &quot; + taxYear + &quot;.&quot;);
<span class="fc" id="L369">                yPosition -= 40;</span>

                // Signature
<span class="fc" id="L372">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc" id="L373">                        &quot;Date : &quot; + LocalDateTime.now().format(DATE_FORMATTER));</span>
<span class="fc" id="L374">                yPosition -= 20;</span>
<span class="fc" id="L375">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
                        &quot;Signature : _______________________&quot;);
            }

<span class="fc" id="L379">            document.save(baos);</span>
<span class="fc" id="L380">            return baos.toByteArray();</span>
        }
    }

    /**
     * Create Form 5001 PDF (Liquidation de dividendes).
     */
    private byte[] createForm5001Pdf(User user, List&lt;Dividend&gt; dividends, Integer taxYear) throws IOException {
<span class="fc" id="L388">        try (PDDocument document = new PDDocument();</span>
<span class="fc" id="L389">             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {</span>

<span class="fc" id="L391">            PDPage page = new PDPage(PDRectangle.A4);</span>
<span class="fc" id="L392">            document.addPage(page);</span>

<span class="fc" id="L394">            try (PDPageContentStream contentStream = new PDPageContentStream(document, page)) {</span>
<span class="fc" id="L395">                float margin = 50;</span>
<span class="fc" id="L396">                float yPosition = page.getMediaBox().getHeight() - margin;</span>
<span class="fc" id="L397">                float fontSize = 10;</span>

<span class="fc" id="L399">                PDType1Font fontBold = new PDType1Font(Standard14Fonts.FontName.HELVETICA_BOLD);</span>
<span class="fc" id="L400">                PDType1Font fontRegular = new PDType1Font(Standard14Fonts.FontName.HELVETICA);</span>

                // Title
<span class="fc" id="L403">                contentStream.setFont(fontBold, 16);</span>
<span class="fc" id="L404">                contentStream.beginText();</span>
<span class="fc" id="L405">                contentStream.newLineAtOffset(margin, yPosition);</span>
<span class="fc" id="L406">                contentStream.showText(&quot;FORMULAIRE 5001&quot;);</span>
<span class="fc" id="L407">                contentStream.endText();</span>
<span class="fc" id="L408">                yPosition -= 20;</span>

<span class="fc" id="L410">                contentStream.setFont(fontBold, 14);</span>
<span class="fc" id="L411">                contentStream.beginText();</span>
<span class="fc" id="L412">                contentStream.newLineAtOffset(margin, yPosition);</span>
<span class="fc" id="L413">                contentStream.showText(&quot;Liquidation de dividendes&quot;);</span>
<span class="fc" id="L414">                contentStream.endText();</span>
<span class="fc" id="L415">                yPosition -= 30;</span>

                // User info
<span class="fc" id="L418">                contentStream.setFont(fontRegular, fontSize);</span>
<span class="fc" id="L419">                yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc" id="L420">                        &quot;Année : &quot; + taxYear + &quot; | Nom : &quot; + user.getFullName());</span>
<span class="fc" id="L421">                yPosition -= 20;</span>

                // Dividends table
<span class="fc" id="L424">                BigDecimal totalGross = BigDecimal.ZERO;</span>
<span class="fc" id="L425">                BigDecimal totalWithholding = BigDecimal.ZERO;</span>
<span class="fc" id="L426">                BigDecimal totalReclaimable = BigDecimal.ZERO;</span>

<span class="fc bfc" id="L428" title="All 2 branches covered.">                for (Dividend dividend : dividends) {</span>
<span class="fc" id="L429">                    yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin, yPosition,</span>
<span class="fc" id="L430">                            String.format(&quot;- %s (%s)&quot;, dividend.getSecurityName(), dividend.getIsin()));</span>
<span class="fc" id="L431">                    yPosition = writeTextLine(contentStream, fontRegular, fontSize, margin + 10, yPosition,</span>
<span class="fc" id="L432">                            String.format(&quot;  Brut: %.2f %s | Retenue: %.2f %s | Récupérable: %.2f %s&quot;,</span>
<span class="fc" id="L433">                                    dividend.getGrossAmount(), dividend.getCurrency(),</span>
<span class="fc" id="L434">                                    dividend.getWithholdingTax(), dividend.getCurrency(),</span>
<span class="fc" id="L435">                                    dividend.getReclaimableAmount(), dividend.getCurrency()));</span>
<span class="fc" id="L436">                    yPosition -= 5;</span>

<span class="fc" id="L438">                    totalGross = totalGross.add(dividend.getGrossAmount());</span>
<span class="fc" id="L439">                    totalWithholding = totalWithholding.add(dividend.getWithholdingTax());</span>
<span class="fc" id="L440">                    totalReclaimable = totalReclaimable.add(dividend.getReclaimableAmount());</span>
<span class="fc" id="L441">                }</span>

<span class="fc" id="L443">                yPosition -= 15;</span>
<span class="fc" id="L444">                contentStream.setFont(fontBold, fontSize);</span>
<span class="fc" id="L445">                yPosition = writeTextLine(contentStream, fontBold, fontSize, margin, yPosition,</span>
<span class="fc" id="L446">                        String.format(&quot;TOTAL - Brut: %.2f | Retenue: %.2f | RÉCUPÉRABLE: %.2f&quot;,</span>
                                totalGross, totalWithholding, totalReclaimable));
            }

<span class="fc" id="L450">            document.save(baos);</span>
<span class="fc" id="L451">            return baos.toByteArray();</span>
        }
    }

    /**
     * Create ZIP bundle with both forms.
     */
    private byte[] createZipBundle(byte[] form5000, byte[] form5001, String userEmail, Integer taxYear)
            throws IOException {

<span class="fc" id="L461">        try (ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L462">             ZipOutputStream zos = new ZipOutputStream(baos)) {</span>

            // Add Form 5000
<span class="fc" id="L465">            ZipEntry entry5000 = new ZipEntry(String.format(&quot;Form_5000_%s_%d.pdf&quot;, userEmail, taxYear));</span>
<span class="fc" id="L466">            zos.putNextEntry(entry5000);</span>
<span class="fc" id="L467">            zos.write(form5000);</span>
<span class="fc" id="L468">            zos.closeEntry();</span>

            // Add Form 5001
<span class="fc" id="L471">            ZipEntry entry5001 = new ZipEntry(String.format(&quot;Form_5001_%s_%d.pdf&quot;, userEmail, taxYear));</span>
<span class="fc" id="L472">            zos.putNextEntry(entry5001);</span>
<span class="fc" id="L473">            zos.write(form5001);</span>
<span class="fc" id="L474">            zos.closeEntry();</span>

<span class="fc" id="L476">            zos.finish();</span>
<span class="fc" id="L477">            return baos.toByteArray();</span>
        }
    }

    /**
     * Upload form PDF to storage.
     */
    private FileUploadResultDTO uploadFormPdf(byte[] pdfBytes, String fileName, String folder) {
<span class="fc" id="L485">        try (ByteArrayInputStream bais = new ByteArrayInputStream(pdfBytes)) {</span>
<span class="fc" id="L486">            return storageService.uploadFile(bais, fileName, &quot;application/pdf&quot;, folder);</span>
<span class="nc" id="L487">        } catch (IOException e) {</span>
<span class="nc" id="L488">            log.error(&quot;Failed to upload form PDF&quot;, e);</span>
<span class="nc" id="L489">            return FileUploadResultDTO.builder()</span>
<span class="nc" id="L490">                    .success(false)</span>
<span class="nc" id="L491">                    .errorMessage(&quot;Failed to upload: &quot; + e.getMessage())</span>
<span class="nc" id="L492">                    .build();</span>
        }
    }

    /**
     * Save generated form to database.
     */
    private GeneratedForm saveGeneratedForm(User user, FileUploadResultDTO uploadResult,
                                            String formType, Integer taxYear, int dividendCount) {
<span class="fc" id="L501">        GeneratedForm form = GeneratedForm.builder()</span>
<span class="fc" id="L502">                .user(user)</span>
<span class="fc" id="L503">                .s3Key(uploadResult.getS3Key())</span>
<span class="fc" id="L504">                .fileName(uploadResult.getFileName())</span>
<span class="fc" id="L505">                .taxYear(taxYear)</span>
<span class="fc" id="L506">                .formType(formType)</span>
<span class="fc" id="L507">                .status(&quot;GENERATED&quot;)</span>
<span class="fc" id="L508">                .expiresAt(LocalDateTime.now().plusDays(formExpiryDays))</span>
<span class="fc" id="L509">                .build();</span>

<span class="fc" id="L511">        return generatedFormRepository.save(form);</span>
    }

    /**
     * Helper to write a text line in PDF.
     */
    private float writeTextLine(PDPageContentStream contentStream, PDType1Font font, float fontSize,
                                 float x, float y, String text) throws IOException {
<span class="fc" id="L519">        contentStream.setFont(font, fontSize);</span>
<span class="fc" id="L520">        contentStream.beginText();</span>
<span class="fc" id="L521">        contentStream.newLineAtOffset(x, y);</span>
<span class="fc" id="L522">        contentStream.showText(text);</span>
<span class="fc" id="L523">        contentStream.endText();</span>
<span class="fc" id="L524">        return y - (fontSize + 5);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>